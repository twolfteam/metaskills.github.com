<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="Ken Collins">
    <meta name="google-site-verification" content="W3DG-CkoWHypH24OfrGmGbMezvhC6AyLql4jLI7hXhI">
    <title>
      Automating Heroku PG Backups @MetaSkills.net
    </title>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/metaskills" title="MetaSkills.net">
    <link rel="author" href="mailto:ken@metaskills.net">
    <link rel="stylesheet" href="/resource/reset.css">
    <link rel="stylesheet" href="/resource/site.css">
    <link rel="shortcut icon" href="/favicon.png">
    <script src="/resource/jquery-1.7.1.min.js">
</script>
    <script src="/resource/site.js">
</script>
  </head>
  <body>
    <header id="mast">
      <div class="content">
        <section id="identity">
          <div id="avatar"></div>
          <div>
            MetaSkills.net
          </div>
          <div>
            Coding things under other things!
          </div>
        </section>
        <nav>
          <ul>
            <li>
              <a href="/" class="button" data-icon="H">Home</a>
            </li>
            <li>
              <a href="/pages/colophon.html" class="button" data-icon="U">About Me</a>
            </li>
            <li>
              <a href="/pages/projects.html" class="button" data-icon="x">Projects</a>
            </li>
            <li>
              <a href="/pages/resume.html" class="button" data-icon="N">Resume</a>
            </li>
            <li>
              <a href="http://twitter.com/metaskills" class="button" data-icon="B">Twitter</a>
            </li>
            <li>
              <a href="/archive.html" class="button" data-icon="l">Archives</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
    <section id="page">
      <section id="content">
        <article id="post">
          <header>
            <time pubdate="" datetime="2011-01-03T00:00:00-05:00"><span class="day">03</span> <span class="month">Jan</span> <span class=
            "year">2011</span></time>
            <h1>
              Automating Heroku PG Backups
            </h1>
          </header>
          <p>
            On December 1st, Heroku <a href="http://blog.heroku.com/archives/2010/12/1/bundles-deprecation/">deprecated their bundles add-on</a> in
            favor of <a href="http://blog.heroku.com/archives/2010/11/16/pgbackups/">their new PG Backups</a>. Even though there are <a href=
            "http://groups.google.com/group/heroku/browse_thread/thread/25402694098d393a">other solutions</a> for automating backups using this new
            add-on, none of them met my needs. I like to have a daily DB backup history, just in case you find something bad that happened "n" days
            earlier. Below is a simple rake task suitable to place in your rails <code>lib/tasks/heroku.task</code> file. I'll explain some things I
            learned below when writing this.
          </p>
          <div>
            <div class="CodeRay">
              <div class="code">
                <pre>
require <span class="string"><span class="delimiter">'</span><span class="content">heroku</span><span class="delimiter">'</span></span>
require <span class="string"><span class="delimiter">'</span><span class="content">heroku/command</span><span class="delimiter">'</span></span>

<span class="constant">HEROKU_BACKUP_BUCKET</span> = <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class=
"inline-delimiter">#{</span><span class="constant">Heroku</span>::<span class="constant">Command</span>::<span class=
"constant">Base</span>.selected_application<span class="inline-delimiter">}</span></span><span class="content">-backups</span><span class=
"delimiter">&quot;</span></span>

namespace <span class="symbol">:heroku</span> <span class="keyword">do</span>
  
  desc <span class="string"><span class="delimiter">&quot;</span><span class=
"content">Use the `heroku pgbackups` with my S3 bucket.</span><span class="delimiter">&quot;</span></span>
  task <span class="symbol">:backup</span> =&gt; <span class="symbol">:connect_to_s3</span> <span class="keyword">do</span>
    info = capture_heroku_command <span class="string"><span class="delimiter">'</span><span class="content">pgbackups</span><span class=
"delimiter">'</span></span>
    <span class="keyword">if</span> heroku_existing_backup?(info)
      last_backup_info = info.split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class=
"delimiter">&quot;</span></span>).last.split(<span class="string"><span class="delimiter">&quot;</span><span class="content"> | </span><span class=
"delimiter">&quot;</span></span>)
      last_backup_id = last_backup_info[<span class="integer">0</span>]
      last_backup_time = last_backup_info[<span class="integer">1</span>]
      puts <span class="string"><span class="delimiter">&quot;</span><span class="content">Deleting last backup - ID: </span><span class=
"inline"><span class="inline-delimiter">#{</span>last_backup_id<span class="inline-delimiter">}</span></span><span class=
"content"> BackupTime: </span><span class="inline"><span class="inline-delimiter">#{</span>last_backup_time<span class=
"inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>
      heroku_command <span class="string"><span class="delimiter">'</span><span class="content">pgbackups:destroy</span><span class=
"delimiter">'</span></span>, last_backup_id
    <span class="keyword">end</span>
    heroku_command <span class="string"><span class="delimiter">'</span><span class="content">pgbackups:capture</span><span class=
"delimiter">'</span></span>
    backup_url = capture_heroku_command <span class="string"><span class="delimiter">'</span><span class="content">pgbackups:url</span><span class=
"delimiter">'</span></span>
    backup_filename = <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class=
"inline-delimiter">#{</span><span class="constant">Heroku</span>::<span class="constant">Command</span>::<span class=
"constant">Base</span>.selected_application<span class="inline-delimiter">}</span></span><span class="content">_</span><span class=
"inline"><span class="inline-delimiter">#{</span><span class="constant">Time</span>.now.xmlschema<span class=
"inline-delimiter">}</span></span><span class="content">.dump</span><span class="delimiter">&quot;</span></span>
    backup_data = <span class="constant">Net</span>::<span class="constant">HTTP</span>.get_response(<span class=
"constant">URI</span>.parse(backup_url)).body
    <span class="constant">AWS</span>::<span class="constant">S3</span>::<span class=
"constant">S3Object</span>.store backup_filename, backup_data, <span class="constant">HEROKU_BACKUP_BUCKET</span>
  <span class="keyword">end</span>
  
  task <span class="symbol">:connect_to_s3</span> <span class="keyword">do</span>
    <span class="constant">AWS</span>::<span class="constant">S3</span>::<span class="constant">Base</span>.establish_connection!(
      <span class="symbol">:access_key_id</span>     =&gt; <span class="predefined-constant">ENV</span>[<span class="string"><span class=
"delimiter">'</span><span class="content">AMAZON_ACCESS_KEY_ID</span><span class="delimiter">'</span></span>],
      <span class="symbol">:secret_access_key</span> =&gt; <span class="predefined-constant">ENV</span>[<span class="string"><span class=
"delimiter">'</span><span class="content">AMAZON_SECRET_ACCESS_KEY</span><span class="delimiter">'</span></span>])
    <span class="keyword">begin</span>
      <span class="constant">AWS</span>::<span class="constant">S3</span>::<span class="constant">Bucket</span>.find(<span class=
"constant">HEROKU_BACKUP_BUCKET</span>)
    <span class="keyword">rescue</span> <span class="constant">AWS</span>::<span class="constant">S3</span>::<span class=
"constant">NoSuchBucket</span>
      <span class="constant">AWS</span>::<span class="constant">S3</span>::<span class="constant">Bucket</span>.create(<span class=
"constant">HEROKU_BACKUP_BUCKET</span>)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  
<span class="keyword">end</span>

private

<span class="keyword">def</span> <span class="function">heroku_command</span>(*cmds)
  <span class="constant">Heroku</span>::<span class="constant">Command</span>::<span class="constant">Base</span>.command(*cmds)
<span class="keyword">end</span>

<span class="keyword">def</span> <span class="function">capture_heroku_command</span>(*cmds)
  stdout = <span class="predefined-constant">STDOUT</span>
  <span class="constant">StringIO</span>.new.tap <span class="keyword">do</span> |out|
    <span class="keyword">def</span> out.<span class="function">flush</span> ; <span class="keyword">end</span>
    <span class="global-variable">$stdout</span> = out
    heroku_command(*cmds)
  <span class="keyword">end</span>.string.chomp
<span class="keyword">ensure</span>
  <span class="global-variable">$stdout</span> = stdout
<span class="keyword">end</span>

<span class="keyword">def</span> <span class="function">heroku_existing_backup?</span>(info)
  info !~ <span class="regexp"><span class="delimiter">/</span><span class="content">no backups</span><span class="delimiter">/</span><span class=
"modifier">i</span></span>
<span class="keyword">end</span>
</pre>
              </div>
            </div>
          </div>
          <p>
            Once installed you can run something like <code>bundle exec rake heroku:backup</code> or if you are not using bundler, <code>rake
            heroku:backup</code>. Assuming you have your S3 credentials setup in the ENV variables, it will find or create a private bucket on your
            S3 account and upload an app-named and time-stamped dump file to that new bucket. If necessary, it <strong>will delete your latest
            backup</strong> on Heroku to make room for this new one. The code should be easy to change, so flavor to taste.
          </p>
          <p>
            I tried to use the Heroku commands built into their plugin without resorting to command interpolation. The only problem was that the
            Heroku gem always wants to print to standard out and flush the buffer. So I created a few private helper methods that temporarily shim in
            a <code>$stdout</code> replacement that does not flush. This let's me run the Heroku commands from code and capture what would have been
            printed to standard out.
          </p>
          <p>
            Lastly, since I could not find a way to automate this on Heroku via their cron add-on, I simply added a <code>launchd</code> plist to my
            desktop Mac that hit a shell script in my project folder to run the rake task. It is way past my skills to try and get RVM to work in the
            <code>launchd.plist</code> system since it is not a true shell. This is why the shell script uses my system ruby (installed via
            MacPorts). Here is the shell script below and the launchd plist which I placed in <code>~/Library/LaunchAgents</code> with a name like
            <code>com.actionmoniker.backupMyApp.plist</code>. Just run <code>launchctl load
            ~/Library/LaunchAgents/com.actionmoniker.backupMyApp.plist</code> and this will run at 4am every morning. If any one finds out how to
            automate the execution of this rake task on Heroku, please drop me a line!
          </p>
          <div>
            <div class="CodeRay">
              <div class="code">
                <pre>
#! /bin/zsh
source /Users/kencollins/.zshenv
cd /Users/kencollins/repos/myapp &amp;&amp; /opt/local/bin/rake heroku:backup
</pre>
              </div>
            </div>
          </div>
          <div>
            <div class="CodeRay">
              <div class="code">
                <pre>
<span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class=
"doctype">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
<span class="tag">&lt;plist</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class=
"content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;dict&gt;</span>
  <span class="tag">&lt;key&gt;</span>Label<span class="tag">&lt;/key&gt;</span>
  <span class="tag">&lt;string&gt;</span>com.actionmoniker.backupMyApp<span class="tag">&lt;/string&gt;</span>
  <span class="tag">&lt;key&gt;</span>ProgramArguments<span class="tag">&lt;/key&gt;</span>
  <span class="tag">&lt;array&gt;</span>
    <span class="tag">&lt;string&gt;</span>/Users/kencollins/repos/myapp/lib/bin/backup.sh<span class="tag">&lt;/string&gt;</span>
  <span class="tag">&lt;/array&gt;</span>
  <span class="tag">&lt;key&gt;</span>StartCalendarInterval<span class="tag">&lt;/key&gt;</span>
  <span class="tag">&lt;dict&gt;</span>
    <span class="tag">&lt;key&gt;</span>Minute<span class="tag">&lt;/key&gt;</span>
    <span class="tag">&lt;integer&gt;</span>0<span class="tag">&lt;/integer&gt;</span>
    <span class="tag">&lt;key&gt;</span>Hour<span class="tag">&lt;/key&gt;</span>
    <span class="tag">&lt;integer&gt;</span>4<span class="tag">&lt;/integer&gt;</span>
  <span class="tag">&lt;/dict&gt;</span>
<span class="tag">&lt;/dict&gt;</span>
<span class="tag">&lt;/plist&gt;</span>
</pre>
              </div>
            </div>
          </div>
          <footer id="disqus_thread">
            <script type="text/javascript">
var disqus_shortname = 'metaskillsnet';
            var disqus_identifier = '/2011/01/03/automating-heroku-pg-backups';
            var disqus_title = "Automating Heroku PG Backups";
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
            </script>
          </footer>
        </article>
      </section>
      <nav>
        <div>
          <a href="http://www.youtube.com/watch?v=8pBTK-pdMP0">Society for coding things on top of other things!</a>
        </div>
        <h3>
          Categories
        </h3>
        <ul>
          <li>
            <a href="/categories/heuristics.html">Heuristics</a>
          </li>
          <li>
            <a href="/categories/workflow.html">Workflow</a>
          </li>
          <li>
            <a href="/categories/apple-os.html">Apple/OS</a>
          </li>
          <li>
            <a href="/categories/database.html">Database</a>
          </li>
          <li>
            <a href="/categories/lifestyle.html">Lifestyle</a>
          </li>
          <li>
            <a href="/categories/miscellaneous.html">Miscellaneous</a>
          </li>
          <li>
            <a href="/categories/ruby-rails.html">Ruby/Rails</a>
          </li>
          <li>
            <a href="/categories/javascript.html">JavaScript</a>
          </li>
          <li>
            <a href="/categories/tools.html">Tools</a>
          </li>
        </ul>
      </nav>
    </section>
    <footer id="foot">
      <section id="footer">
        <section id="recentposts">
          <h3>
            Recent Posts
          </h3>
          <article>
            <h4>
              Instrumenting Your Code With ActiveSupport Notifications
            </h4>
            <p>
              <a href="/2013/12/15/instrumenting-your-code-with-activesupport-notifications">Have you ever wondered how tools like New Relic are able
              to gain valuable metrics to your Rails application's internals? Or maybe you are interested in learning how to write...</a>
            </p>
          </article>
          <article>
            <h4>
              Using Dotenv In Rails
            </h4>
            <p>
              <a href="/2013/10/03/using-dotenv-in-rails">Environment variables as a configuration means are everywhere in Ruby. For instance,
              ActiveRecord will use the single `DATABASE_URL` environment variable for every part of it's configuration, no database.yml needed!
              If...</a>
            </p>
          </article>
          <article>
            <h4>
              Jekyll Tips And Tricks
            </h4>
            <p>
              <a href="/2013/09/02/jekyll-tips-and-tricks">IT'S DANGEROUS TO GO ALONE! TAKE THIS! Our t-shirt fund-raiser on Booster.com only has a
              few days left. Don't miss out on this 8-bit-tacular Ruby shirt! Available in men, ladies...</a>
            </p>
          </article>
          <aside id="powered">
            <span>Powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://disqus.com">Disqus</a>. Check out <a href=
            "https://github.com/metaskills/metaskills.net">the code</a>.</span><br>
            <span>&copy; 2006-2014 Ken Collins. All rights reserved.</span>
          </aside>
          <aside id="html5_badge">
            <a href="http://www.w3.org/html/logo/"></a>
          </aside>
        </section>
        <section id="badges">
          <ul>
            <li>
              <a id="badge_757rb" href="http://757rb.org/"></a>
            </li>
            <li>
              <a id="badge_speakerdeck" href="http://speakerdeck.com/u/metaskills"></a>
            </li>
            <li>
              <a id="badge_railscore" href="http://contributors.rubyonrails.org/contributors/ken-collins/commits"></a>
            </li>
            <li>
              <a id="badge_pragalumni" href="http://alumni.pragmaticstudio.com/users/128"></a>
            </li>
            <li>
              <a id="badge_js" href="https://developer.mozilla.org/en/JavaScript" title='JavaScript'>JavaScript</a>
            </li>
            <li>
              <a id="badge_ios" href="http://developer.apple.com/"></a>
            </li>
            <li>
              <a id="badge_linkedin" href="http://www.linkedin.com/in/metaskills"></a>
            </li>
          </ul>
        </section>
        <section id="blogroll">
          <h3>
            Blogroll
          </h3>
          <ul>
            <li>
              <a href="http://technology.customink.com">CustomInk Technology</a>
            </li>
            <li>
              <a href="http://fearoffish.com">Jamie van Dyke</a>
            </li>
            <li>
              <a href="http://ryan.mcgeary.org/">Ryan McGeary</a>
            </li>
            <li>
              <a href="http://www.buzzwordcompliant.net/">Mike Buckbee</a>
            </li>
            <li>
              <a href="http://brennandunn.com">Brennan Dunn</a>
            </li>
            <li>
              <a href="http://evan.tiggerpalace.com">Evan Light</a>
            </li>
            <li>
              <a href="http://techiferous.com">Wyatt Greene</a>
            </li>
            <li>
              <a href="http://www.engineyard.com/blog/author/wayneseguin/">Wayne E. Sequin</a>
            </li>
          </ul>
        </section>
      </section>
    </footer>
  </body>
</html>
