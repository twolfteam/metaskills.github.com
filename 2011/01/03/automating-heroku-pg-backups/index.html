<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="Ken Collins">
    <meta name="google-site-verification" content="W3DG-CkoWHypH24OfrGmGbMezvhC6AyLql4jLI7hXhI">
    <title>
      Automating Heroku PG Backups @MetaSkills.net
    </title>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/metaskills" title="MetaSkills.net">
    <link rel="author" href="mailto:ken@metaskills.net">
    <link rel="stylesheet" href="/resource/reset.css" type="text/css">
    <link rel="stylesheet" href="/resource/site.css" type="text/css">
    <link rel="shortcut icon" href="/favicon.png">
    <script src="/resource/zepto.js" type="text/javascript">
</script>
    <script src="/resource/site.js" type="text/javascript">
</script>
  </head>
  <body>
    <header id="mast">
      <div class="content">
        <section id="identity">
          <div id="avatar"></div>
          <div>
            MetaSkills.net
          </div>
          <div>
            Coding things under other things!
          </div>
        </section>
        <nav>
          <ul>
            <li>
              <a href="/" class="button" data-icon="H">Home</a>
            </li>
            <li>
              <a href="/pages/colophon.html" class="button" data-icon="i">Colophon</a>
            </li>
            <li>
              <a href="/pages/projects.html" class="button" data-icon="x">Projects</a>
            </li>
            <li>
              <a href="http://twitter.com/metaskills" class="button" data-icon="B">Follow</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
    <section id="page">
      <section id="content">
        <article id="post">
          <header>
            <time pubdate datetime="2011-01-03T00:00:00-05:00">
              <span class="day">03</span> <span class="month">Jan</span> <span class="year">2011</span>
            </time>
            <h1>
              Automating Heroku PG Backups
            </h1>
          </header>
          <p>
            On December 1st, Heroku <a href="http://blog.heroku.com/archives/2010/12/1/bundles-deprecation/">deprecated their bundles add-on</a> in
            favor of <a href="http://blog.heroku.com/archives/2010/11/16/pgbackups/">their new PG Backups</a>. Even though there are <a href=
            "http://groups.google.com/group/heroku/browse_thread/thread/25402694098d393a">other solutions</a> for automating backups using this new
            add-on, none of them met my needs. I like to have a daily DB backup history, just in case you find something bad that happened "n" days
            earlier. Below is a simple rake task suitable to place in your rails <code>lib/tasks/heroku.task</code> file. I'll explain some things I
            learned below when writing this.
          </p>
          <div class="highlight">
            <pre>
<code class="ruby"><span class="nb">require</span> <span class="s1">&#39;heroku&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;heroku/command&#39;</span>

<span class="no">HEROKU_BACKUP_BUCKET</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class=
"no">Heroku</span><span class="o">::</span><span class="no">Command</span><span class="o">::</span><span class="no">Base</span><span class=
"o">.</span><span class="n">selected_application</span><span class="si">}</span><span class="s2">-backups&quot;</span>

<span class="n">namespace</span> <span class="ss">:heroku</span> <span class="k">do</span>
  
  <span class="n">desc</span> <span class="s2">&quot;Use the `heroku pgbackups` with my S3 bucket.&quot;</span>
  <span class="n">task</span> <span class="ss">:backup</span> <span class="o">=&gt;</span> <span class="ss">:connect_to_s3</span> <span class=
"k">do</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">capture_heroku_command</span> <span class="s1">&#39;pgbackups&#39;</span>
    <span class="k">if</span> <span class="n">heroku_existing_backup?</span><span class="p">(</span><span class="n">info</span><span class=
"p">)</span>
      <span class="n">last_backup_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class=
"n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class=
"p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">split</span><span class=
"p">(</span><span class="s2">&quot; | &quot;</span><span class="p">)</span>
      <span class="n">last_backup_id</span> <span class="o">=</span> <span class="n">last_backup_info</span><span class="o">[</span><span class=
"mi">0</span><span class="o">]</span>
      <span class="n">last_backup_time</span> <span class="o">=</span> <span class="n">last_backup_info</span><span class="o">[</span><span class=
"mi">1</span><span class="o">]</span>
      <span class="nb">puts</span> <span class="s2">&quot;Deleting last backup - ID: </span><span class="si">#{</span><span class=
"n">last_backup_id</span><span class="si">}</span><span class="s2"> BackupTime: </span><span class="si">#{</span><span class=
"n">last_backup_time</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">heroku_command</span> <span class="s1">&#39;pgbackups:destroy&#39;</span><span class="p">,</span> <span class=
"n">last_backup_id</span>
    <span class="k">end</span>
    <span class="n">heroku_command</span> <span class="s1">&#39;pgbackups:capture&#39;</span>
    <span class="n">backup_url</span> <span class="o">=</span> <span class="n">capture_heroku_command</span> <span class=
"s1">&#39;pgbackups:url&#39;</span>
    <span class="n">backup_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class=
"no">Heroku</span><span class="o">::</span><span class="no">Command</span><span class="o">::</span><span class="no">Base</span><span class=
"o">.</span><span class="n">selected_application</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class=
"no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">xmlschema</span><span class=
"si">}</span><span class="s2">.dump&quot;</span>
    <span class="n">backup_data</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class=
"no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class=
"o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">backup_url</span><span class="p">))</span><span class=
"o">.</span><span class="n">body</span>
    <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class=
"no">S3Object</span><span class="o">.</span><span class="n">store</span> <span class="n">backup_filename</span><span class="p">,</span> <span class=
"n">backup_data</span><span class="p">,</span> <span class="no">HEROKU_BACKUP_BUCKET</span>
  <span class="k">end</span>
  
  <span class="n">task</span> <span class="ss">:connect_to_s3</span> <span class="k">do</span>
    <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class="no">Base</span><span class=
"o">.</span><span class="n">establish_connection!</span><span class="p">(</span>
      <span class="ss">:access_key_id</span>     <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class=
"s1">&#39;AMAZON_ACCESS_KEY_ID&#39;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:secret_access_key</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class=
"s1">&#39;AMAZON_SECRET_ACCESS_KEY&#39;</span><span class="o">]</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class=
"no">Bucket</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="no">HEROKU_BACKUP_BUCKET</span><span class=
"p">)</span>
    <span class="k">rescue</span> <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class=
"no">NoSuchBucket</span>
      <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class=
"no">Bucket</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class=
"no">HEROKU_BACKUP_BUCKET</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
<span class="k">end</span>

<span class="kp">private</span>

<span class="k">def</span> <span class="nf">heroku_command</span><span class="p">(</span><span class="o">*</span><span class=
"n">cmds</span><span class="p">)</span>
  <span class="no">Heroku</span><span class="o">::</span><span class="no">Command</span><span class="o">::</span><span class=
"no">Base</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="o">*</span><span class=
"n">cmds</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">capture_heroku_command</span><span class="p">(</span><span class="o">*</span><span class=
"n">cmds</span><span class="p">)</span>
  <span class="n">stdout</span> <span class="o">=</span> <span class="no">STDOUT</span>
  <span class="no">StringIO</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">tap</span> <span class=
"k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="k">def</span> <span class="nc">out</span><span class="o">.</span><span class="nf">flush</span> <span class="p">;</span> <span class=
"k">end</span>
    <span class="vg">$stdout</span> <span class="o">=</span> <span class="n">out</span>
    <span class="n">heroku_command</span><span class="p">(</span><span class="o">*</span><span class="n">cmds</span><span class="p">)</span>
  <span class="k">end</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">chomp</span>
<span class="k">ensure</span>
  <span class="vg">$stdout</span> <span class="o">=</span> <span class="n">stdout</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">heroku_existing_backup?</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
  <span class="n">info</span> <span class="o">!~</span> <span class="sr">/no backups/i</span>
<span class="k">end</span>
</code>
</pre>
          </div>
          <p>
            Once installed you can run something like <code>bundle exec rake heroku:backup</code> or if you are not using bundler, <code>rake
            heroku:backup</code>. Assuming you have your S3 credentials setup in the ENV variables, it will find or create a private bucket on your
            S3 account and upload an app-named and time-stamped dump file to that new bucket. If necessary, it <strong>will delete your latest
            backup</strong> on Heroku to make room for this new one. The code should be easy to change, so flavor to taste.
          </p>
          <p>
            I tried to use the Heroku commands built into their plugin without resorting to command interpolation. The only problem was that the
            Heroku gem always wants to print to standard out and flush the buffer. So I created a few private helper methods that temporarily shim in
            a <code>$stdout</code> replacement that does not flush. This let's me run the Heroku commands from code and capture what would have been
            printed to standard out.
          </p>
          <p>
            Lastly, since I could not find a way to automate this on Heroku via their cron add-on, I simply added a <code>launchd</code> plist to my
            desktop Mac that hit a shell script in my project folder to run the rake task. It is way past my skills to try and get RVM to work in the
            <code>launchd.plist</code> system since it is not a true shell. This is why the shell script uses my system ruby (installed via
            MacPorts). Here is the shell script below and the launchd plist which I placed in <code>~/Library/LaunchAgents</code> with a name like
            <code>com.actionmoniker.backupMyApp.plist</code>. Just run <code>launchctl load
            ~/Library/LaunchAgents/com.actionmoniker.backupMyApp.plist</code> and this will run at 4am every morning. If any one finds out how to
            automate the execution of this rake task on Heroku, please drop me a line!
          </p>
          <div class="highlight">
            <pre>
<code class="bash"><span class="c">#! /bin/zsh</span>
<span class="nb">source</span> /Users/kencollins/.zshenv
<span class="nb">cd</span> /Users/kencollins/repos/myapp <span class="o">&amp;&amp;</span> /opt/local/bin/rake heroku:backup
</code>
</pre>
          </div>
          <div class="highlight">
            <pre>
<code class="html"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class=
"cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
<span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
  <span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;string&gt;</span>com.actionmoniker.backupMyApp<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;array&gt;</span>
    <span class="nt">&lt;string&gt;</span>/Users/kencollins/repos/myapp/lib/bin/backup.sh<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;/array&gt;</span>
  <span class="nt">&lt;key&gt;</span>StartCalendarInterval<span class="nt">&lt;/key&gt;</span>
  <span class="nt">&lt;dict&gt;</span>
    <span class="nt">&lt;key&gt;</span>Minute<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>0<span class="nt">&lt;/integer&gt;</span>
    <span class="nt">&lt;key&gt;</span>Hour<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;integer&gt;</span>4<span class="nt">&lt;/integer&gt;</span>
  <span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/plist&gt;</span>
</code>
</pre>
          </div>
          <footer id="disqus_thread">
            <script type="text/javascript">
var disqus_shortname = 'metaskillsnet';
            var disqus_identifier = '/2011/01/03/automating-heroku-pg-backups';
            var disqus_title = "Automating Heroku PG Backups";
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
            </script>
          </footer>
        </article>
      </section>
      <nav>
        <div>
          <a href="http://www.youtube.com/watch?v=8pBTK-pdMP0">Society for coding things on top of other things!</a>
        </div>
        <h3>
          Categories
        </h3>
        <ul>
          <li>
            <a href="/categories/heuristics.html">Heuristics</a>
          </li>
          <li>
            <a href="/categories/workflow.html">Workflow</a>
          </li>
          <li>
            <a href="/categories/apple-os.html">Apple/OS</a>
          </li>
          <li>
            <a href="/categories/database.html">Database</a>
          </li>
          <li>
            <a href="/categories/lifestyle.html">Lifestyle</a>
          </li>
          <li>
            <a href="/categories/miscellaneous.html">Miscellaneous</a>
          </li>
          <li>
            <a href="/categories/ruby-rails.html">Ruby/Rails</a>
          </li>
          <li>
            <a href="/categories/javascript.html">JavaScript</a>
          </li>
          <li>
            <a href="/categories/tools.html">Tools</a>
          </li>
        </ul>
      </nav>
    </section>
    <footer id="foot">
      <section id="footer">
        <section id="recentposts">
          <h3>
            Recent Posts
          </h3>
          <article>
            <h4>
              Rails &amp; Spine.JS - Jasmine Testing Part 2
            </h4>
            <p>
              <a href="/2012/01/17/rails-and-spine-js-jasmine-testing-part-2">So this is the third part to my mini series on Rails and Spine.JS. Part
              one covers an initial setup and how to include Spine.JS into your Rails project while...</a>
            </p>
          </article>
          <article>
            <h4>
              Rails &amp; Spine.JS - Jasmine Testing Part 1
            </h4>
            <p>
              <a href="/2012/01/16/rails-and-spine-js-jasmine-testing-part-1">In my previous article I talked a little bit about why I decided to use
              Spine.JS and how to include the CoffeeScript source into your Rails project using git submodules....</a>
            </p>
          </article>
          <article>
            <h4>
              Rails &amp; Spine.JS - Using The CoffeeScript Source
            </h4>
            <p>
              <a href="/2012/01/15/rails-and-spine-js-using-the-coffeescript-source">Our options for JavaScript MVC frameworks are numerous these
              days. While working on the third major rewrite of my personal bookmarking application, HomeMarks, I decided to learn Backbone.js.
              Thankfully a...</a>
            </p>
          </article>
          <aside id="powered">
            <span>Powered by <a href="http://github.com/henrik/jekyll">Jekyll</a> and <a href="http://disqus.com">Disqus</a>. Check out <a href=
            "https://github.com/metaskills/metaskills.net">the code</a>.</span><br>
            <span>&copy; 2006-2012 Ken Collins. All rights reserved.</span>
          </aside>
          <aside id="html5_badge">
            <a href="http://www.w3.org/html/logo/"></a>
          </aside>
        </section>
        <section id="badges">
          <ul>
            <li>
              <a id="badge_js" href="https://developer.mozilla.org/en/JavaScript" title='JavaScript'>JavaScript</a>
            </li>
            <li>
              <a id="badge_ios" href="http://developer.apple.com/"></a>
            </li>
            <li>
              <a id="badge_railscore" href="http://contributors.rubyonrails.org/contributors/ken-collins/commits"></a>
            </li>
            <li>
              <a id="badge_pragalumni" href="http://alumni.pragmaticstudio.com/users/128"></a>
            </li>
            <li>
              <a id="badge_linkedin" href="http://www.linkedin.com/in/metaskills"></a>
            </li>
            <li>
              <a id="badge_slideshare" href="http://www.slideshare.net/metaskills"></a>
            </li>
            <li>
              <a id="badge_757rb" href="http://757rb.org/"></a>
            </li>
          </ul>
        </section>
        <section id="blogroll">
          <h3>
            Blogroll
          </h3>
          <ul>
            <li>
              <a href="http://ryan.mcgeary.org/">Ryan McGeary</a>
            </li>
            <li>
              <a href="http://www.linkedin.com/in/imbriaco">Mark Imbriaco</a>
            </li>
            <li>
              <a href="http://mwhuss.com/">Marshall Huss</a>
            </li>
            <li>
              <a href="http://fun3d.larc.nasa.gov/">Bil Kleb</a>
            </li>
            <li>
              <a href="http://www.buzzwordcompliant.net/">Mike Buckbee</a>
            </li>
            <li>
              <a href="http://www.candescence.org/">Geoff Parsons</a>
            </li>
            <li>
              <a href="http://www.wearetitans.net/">Brennan Dunn</a>
            </li>
            <li>
              <a href="http://evan.tiggerpalace.com/">Evan Light</a>
            </li>
            <li>
              <a href="http://techiferous.com/">Wyatt Greene</a>
            </li>
            <li>
              <a href="http://www.engineyard.com/blog/author/wayneseguin/">Wayne E. Sequin</a>
            </li>
          </ul>
        </section>
      </section>
    </footer>
  </body>
</html>
