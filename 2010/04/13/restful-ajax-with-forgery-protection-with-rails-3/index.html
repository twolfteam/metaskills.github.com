<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="Ken Collins">
    <meta name="google-site-verification" content="W3DG-CkoWHypH24OfrGmGbMezvhC6AyLql4jLI7hXhI">
    <title>
      RESTful AJAX with Forgery Protection (In Rails 3) @MetaSkills.net
    </title>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/metaskills" title="MetaSkills.net">
    <link rel="author" href="mailto:ken@metaskills.net">
    <link rel="stylesheet" href="/resource/reset.css" type="text/css">
    <link rel="stylesheet" href="/resource/site.css" type="text/css">
    <link rel="shortcut icon" href="/favicon.png">
    <script src="/resource/zepto.js" type="text/javascript">
</script>
    <script src="/resource/site.js" type="text/javascript">
</script>
  </head>
  <body>
    <header id="mast">
      <div class="content">
        <section id="identity">
          <div id="avatar"></div>
          <div>
            MetaSkills.net
          </div>
          <div>
            Coding things under other things!
          </div>
        </section>
        <nav>
          <ul>
            <li>
              <a href="/" class="button" data-icon="H">Home</a>
            </li>
            <li>
              <a href="/pages/colophon.html" class="button" data-icon="i">Colophon</a>
            </li>
            <li>
              <a href="/pages/projects.html" class="button" data-icon="x">Projects</a>
            </li>
            <li>
              <a href="http://twitter.com/metaskills" class="button" data-icon="B">Follow</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
    <section id="page">
      <section id="content">
        <article id="post">
          <header>
            <time pubdate datetime="2010-04-13T00:00:00-04:00">
              <span class="day">13</span> <span class="month">Apr</span> <span class="year">2010</span>
            </time>
            <h1>
              RESTful AJAX with Forgery Protection (In Rails 3)
            </h1>
          </header>
          <p>
            A <a href="/2008/6/18/restful-ajax-with-forgery-protection">while back ago</a> I wrote an article about how to use Rails built-in forgery
            protection in your RESTful AJAX calls. Normally AJAX requests, those responding true to <code>request.xhr?</code> in rails, are forgery
            whitelisted. But sometimes, and under what conditions I am not sure, AJAX methods are subjected to forgery protection. Maybe you have the
            <code>ActionDispatch::Request#forgery_whitelisted?</code> overridden to not include AJAX requests? Either way and for whatever reason â€“
            if you like to use forgery protection in your RESTful AJAX calls to rails, then here is the new implementation under Rails 3 beta2.
          </p>
          <h2>
            Forgery Protection In Rails 3
          </h2>
          <p>
            In a pre Rails 3 application all form tag helpers automatically create a hidden form field that contain the authentication token. These
            are passed when the form is serialized and if you viewed source, you could see them. However, Rails 3 is unobtrusive, which means you can
            count on them not polluting your markup with this kind of framework data. So where do the authentication params come from in a Rails 3
            application? The answer is two places. First there is a new <code>ActionView::Helpers::CsrfHelper</code> module that allows you to use
            the #csrf_meta_tag helper in the head of your layout files. This helper will generate two meta tags, one for the authentication parameter
            name and the other for the value. The second place is in the new rails.js which reads these two meta tags for further interpolation into
            some generated form tags for all sorts of :remote links, buttons, etc. If your interested in reading more about these, look into the
            source, but I thought you might like to see some places where these are used by the framework now.
          </p>
          <div class="highlight">
            <pre>
<code class="html"><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class=
"na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">/&gt;</span>
  <span class="err">&lt;</span>%= csrf_meta_tag %&gt;
</code>
</pre>
          </div>
          <div class="highlight">
            <pre>
<code class="javascript"><span class="nb">document</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class=
"s2">&quot;dom:loaded&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">authToken</span> <span class="o">=</span> <span class="nx">$$</span><span class=
"p">(</span><span class="s1">&#39;meta[name=csrf-token]&#39;</span><span class="p">).</span><span class="nx">first</span><span class=
"p">().</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">),</span>
    <span class="nx">authParam</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class=
"s1">&#39;meta[name=csrf-param]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class=
"nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">),</span>
    <span class="nx">formTemplate</span> <span class="o">=</span> <span class=
"s1">&#39;&lt;form method=&quot;#{method}&quot; action=&quot;#{action}&quot;&gt;\</span>
<span class="s1">      #{realmethod}&lt;input name=&quot;#{param}&quot; value=&quot;#{token}&quot; type=&quot;hidden&quot;&gt;\</span>
<span class="s1">      &lt;/form&gt;&#39;</span><span class="p">,</span>
    <span class="nx">realmethodTemplate</span> <span class="o">=</span> <span class=
"s1">&#39;&lt;input name=&quot;_method&quot; value=&quot;#{method}&quot; type=&quot;hidden&quot;&gt;&#39;</span><span class="p">;</span>
  <span class="c1">//... etc</span>
</code>
</pre>
          </div>
          <h2>
            Now Our RESTful AJAX with Forgery Protection
          </h2>
          <p>
            OK, now that bit of background information is out of the way, lets look into how we can use this for ourselves. Since Rails 3 has
            provided us with a good convention, we can hook into this pretty easily. This prototype example below is pretty simple and follows my
            OOJS approach. I have a base JS object that is basically a module with a function called authParams. I then mixin this base JS object
            into all my Prototype classes. We are reading the same meta tags that rails now uses and create a Prototype Hash object with the
            name/value of the authentication token. Then in ever AJAX request I merge these parameters in with what ever I am serializing for that
            request. Pretty simple eh? Did I miss anything?
          </p>
          <div class="highlight">
            <pre>
<code class="javascript"><span class="c1">// A base JS object.</span>

<span class="kd">var</span> <span class="nx">MyBase</span> <span class="o">=</span> <span class="p">{</span>

  <span class="nx">authParams</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">var</span> <span class="nx">authParam</span> <span class="o">=</span> <span class="nx">$$</span><span class=
"p">(</span><span class="s1">&#39;meta[name=csrf-param]&#39;</span><span class="p">).</span><span class="nx">first</span><span class=
"p">().</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">authToken</span> <span class="o">=</span> <span class="nx">$$</span><span class=
"p">(</span><span class="s1">&#39;meta[name=csrf-token]&#39;</span><span class="p">).</span><span class="nx">first</span><span class=
"p">().</span><span class="nx">readAttribute</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
    <span class="nx">params</span><span class="p">[</span><span class="nx">authParam</span><span class="p">]</span> <span class=
"o">=</span> <span class="nx">authToken</span>
    <span class="k">return</span> <span class="nx">$H</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span>

<span class="c1">// Mixed Into Other Classes.</span>

<span class="kd">var</span> <span class="nx">SomeClass</span> <span class="o">=</span> <span class="nx">Class</span><span class=
"p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">MyBase</span><span class="p">,{</span>

  <span class="nx">doAjaxRequest</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class=
"p">(</span><span class="nx">elmnt</span><span class="p">.</span><span class="nx">action</span><span class="p">,{</span>
      <span class="nx">parameters</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class=
"nx">form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="kc">true</span><span class=
"p">).</span><span class="nx">merge</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class=
"nx">authParams</span><span class="p">()),</span>
    <span class="p">});</span>
  <span class="p">}</span>

<span class="p">});</span>
</code>
</pre>
          </div>
          <footer id="disqus_thread">
            <script type="text/javascript">
var disqus_shortname = 'metaskillsnet';
            var disqus_identifier = '/2010/04/13/restful-ajax-with-forgery-protection-with-rails-3/';
            var disqus_title = 'RESTful AJAX with Forgery Protection (In Rails 3)';
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
            </script>
          </footer>
        </article>
      </section>
      <nav>
        <div>
          <a href="http://www.youtube.com/watch?v=8pBTK-pdMP0">Society for coding things on top of other things!</a>
        </div>
        <h3>
          Categories
        </h3>
        <ul>
          <li>
            <a href="/categories/heuristics.html">Heuristics</a>
          </li>
          <li>
            <a href="/categories/workflow.html">Workflow</a>
          </li>
          <li>
            <a href="/categories/apple-os.html">Apple/OS</a>
          </li>
          <li>
            <a href="/categories/database.html">Database</a>
          </li>
          <li>
            <a href="/categories/lifestyle.html">Lifestyle</a>
          </li>
          <li>
            <a href="/categories/miscellaneous.html">Miscellaneous</a>
          </li>
          <li>
            <a href="/categories/ruby-rails.html">Ruby/Rails</a>
          </li>
          <li>
            <a href="/categories/javascript.html">JavaScript</a>
          </li>
          <li>
            <a href="/categories/tools.html">Tools</a>
          </li>
        </ul>
      </nav>
    </section>
    <footer id="foot">
      <section id="footer">
        <section id="recentposts">
          <h3>
            Recent Posts
          </h3>
          <article>
            <h4>
              How Do You Encapsulate Your JavaScript
            </h4>
            <p>
              <a href="/2011/09/06/how-do-you-encapsulate-your-javascript">I ask this question a lot! To Job candidates, friends, and almost any
              developer that says they work with JavaScript. I believe how you encapsulate your JavaScript is a good...</a>
            </p>
          </article>
          <article>
            <h4>
              jQuery Mobile &amp; Rails
            </h4>
            <p>
              <a href="/2011/08/24/jquery-mobile-and-rails">I just finished my first dive into using jQuery Mobile with a Rails application and
              wanted to share some techniques that came out along the way. Hopefully these will help...</a>
            </p>
          </article>
          <article>
            <h4>
              Use Compass Sass Framework Files With The Rails 3.1.0.rc5 Asset Pipeline
            </h4>
            <p>
              <a href="/2011/07/29/use-compass-sass-framework-files-with-the-rails-3.1.0.rc5-asset-pipeline">This is a simple update to my original
              article for using compass's .scss files with the asset pipeline. This assumes you had this setup working in Rails 3.1.0.rc4, but
              should...</a>
            </p>
          </article>
          <aside id="powered">
            <span>Powered by <a href="http://github.com/henrik/jekyll">Jekyll</a> and <a href="http://disqus.com">Disqus</a>. Check out <a href=
            "https://github.com/metaskills/metaskills.net">the code</a>.</span><br>
            <span>&copy; 2006-2011 Ken Collins. All rights reserved.</span>
          </aside>
          <aside id="html5_badge">
            <a href="http://www.w3.org/html/logo/"></a>
          </aside>
        </section>
        <section id="badges">
          <ul>
            <li>
              <a id="badge_js" href="https://developer.mozilla.org/en/JavaScript" title='JavaScript'>JavaScript</a>
            </li>
            <li>
              <a id="badge_ios" href="http://developer.apple.com/"></a>
            </li>
            <li>
              <a id="badge_railscore" href="http://contributors.rubyonrails.org/contributors/ken-collins/commits"></a>
            </li>
            <li>
              <a id="badge_pragalumni" href="http://alumni.pragmaticstudio.com/users/128"></a>
            </li>
            <li>
              <a id="badge_linkedin" href="http://www.linkedin.com/in/metaskills"></a>
            </li>
            <li>
              <a id="badge_slideshare" href="http://www.slideshare.net/metaskills"></a>
            </li>
            <li>
              <a id="badge_757rb" href="http://757rb.org/"></a>
            </li>
          </ul>
        </section>
        <section id="blogroll">
          <h3>
            Blogroll
          </h3>
          <ul>
            <li>
              <a href="http://ryan.mcgeary.org/">Ryan McGeary</a>
            </li>
            <li>
              <a href="http://www.linkedin.com/in/imbriaco">Mark Imbriaco</a>
            </li>
            <li>
              <a href="http://mwhuss.com/">Marshall Huss</a>
            </li>
            <li>
              <a href="http://fun3d.larc.nasa.gov/">Bil Kleb</a>
            </li>
            <li>
              <a href="http://www.buzzwordcompliant.net/">Mike Buckbee</a>
            </li>
            <li>
              <a href="http://www.candescence.org/">Geoff Parsons</a>
            </li>
            <li>
              <a href="http://www.wearetitans.net/">Brennan Dunn</a>
            </li>
            <li>
              <a href="http://evan.tiggerpalace.com/">Evan Light</a>
            </li>
            <li>
              <a href="http://techiferous.com/">Wyatt Greene</a>
            </li>
            <li>
              <a href="http://www.engineyard.com/blog/author/wayneseguin/">Wayne E. Sequin</a>
            </li>
          </ul>
        </section>
      </section>
    </footer>
  </body>
</html>
