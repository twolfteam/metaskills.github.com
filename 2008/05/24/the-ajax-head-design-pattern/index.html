<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="Ken Collins">
    <title>
      The "AJAX Head" Design Pattern @MetaSkills.net
    </title>
    <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/metaskills" title="MetaSkills.net">
    <link rel="author" href="mailto:ken@metaskills.net">
    <link rel="stylesheet" href="/resource/reset.css" type="text/css">
    <link rel="stylesheet" href="/resource/site.css" type="text/css">
    <link rel="shortcut icon" href="/favicon.png">
    <script src="/resource/zepto.js" type="text/javascript">
</script>
    <script src="/resource/site.js" type="text/javascript">
</script>
  </head>
  <body>
    <header id="mast">
      <div class="content">
        <section id="identity">
          <div id="avatar"></div>
          <div>
            MetaSkills.net
          </div>
          <div>
            Coding things under other things!
          </div>
        </section>
        <nav>
          <ul>
            <li>
              <a href="/" class="button" data-icon="H">Home</a>
            </li>
            <li>
              <a href="/pages/colophon.html" class="button" data-icon="i">Colophon</a>
            </li>
            <li>
              <a href="/pages/projects.html" class="button" data-icon="x">Projects</a>
            </li>
            <li>
              <a href="http://twitter.com/metaskills" class="button" data-icon="B">Follow</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
    <section id="page">
      <section id="content">
        <article id="post">
          <header>
            <time pubdate datetime="2008-05-24T00:00:00-04:00">
              <span class="day">24</span> <span class="month">May</span> <span class="year">2008</span>
            </time>
            <h1>
              The "AJAX Head" Design Pattern
            </h1>
          </header>
          <aside class="flash_info">
            Chris Williams did a really great write up on this pattern with great details on when/how to use it. Please considering <a href=
            "http://voodootikigod.com/ajax-head-design-pattern">reading it</a> afterward.
          </aside>
          <p>
            This is the first of a few articles covering the total rewrite of the <a href="http://homemarks.com/">HomeMarks.com</a> code base as I
            upgrade it to Rails 2.1. The "AJAX Head" pattern is the moniker I have assigned to methodology that has come about during said rewrite
            and the design decisions I choose early on. The rules were simple.
          </p>
          <ul>
            <li>Total Unobtrusive JavaScript (<a href="http://en.wikipedia.org/wiki/Tag_soup">No Tag Soup</a>)
            </li>
            <li>No RJS Controller Responses
            </li>
          </ul>
          <p>
            Rails makes it very easy to generate JavaScript with Ruby. The generator methods are extensive and cover both the Prototype and
            Scriptaculous libraries. The first version of HomeMarks used the generators exclusively to augment both the views and controller
            responses. In fact, I used a technique that is covered in the latest <a href=
            "http://www.pragprog.com/titles/fr_arr/advanced-rails-recipes"><em>Advanced Rails Recipes</em></a> (way before it came out) under the
            "Replace In-View Raw JavaScript" chapter. Basically I created helper methods that generated JavaScript shared by both the views and
            controllers. It was a great technique but things <a href=
            "http://github.com/metaskills/homemarks/tree/d33dab1405537db2d2dab86d79db415d9e7f56e5/app/helpers/application_helper.rb">got messy
            quick</a>. So life was good back then, I had a lot of Ruby code and a very dynamic site, but something did not seem right...
          </p>
          <h2>
            What Is The AJAX Head Pattern?
          </h2>
          <p>
            It is an experiment into a vision to see what happens when you make the decision to totally go unobtrusive. Not just in your views but
            the controllers too! Imagine it this way &mdash; your controllers are <strong>slim APIs</strong>. They should do nothing but render a
            page on a GET request and when it comes to a POST/PUT/DELETE they should do nothing more than just say YES or NO (with errors).
          </p>
          <p>
            Now lets think about that. What does that mean for an application that uses exclusive AJAX calls for dynamic page updates? It means that
            your visual client (the browser) will need to know ALOT less from the controller about what to do. It's great, the browser knows what is
            on the page, from the GET request, and what it needs to do with it. The client only needs to tell the remote resource store what it did.
            In this pattern the controller is relegated to nothing more than acting on model data and letting the client know if it succeeded or
            failed. So in short.
          </p>
          <blockquote>
            The AJAX head design pattern forces the view and controller to work in isolation with the most minimal coupling possible. Kind of like a
            web service.
          </blockquote>
          <h2>
            Tools and Code Needed
          </h2>
          <ul>
            <li>A application that does just about everything with AJAX.
            </li>
            <li>Fluency with ActionController::Base#head method and HTTP status codes.
            </li>
            <li>Site-wide exception rescues for ActiveRecord::RecordInvalid.
            </li>
            <li>Global client-side AJAX request and response handlers.
            </li>
            <li>Global client-side error handlers.
            </li>
          </ul>
          <p>
            This may seem like a daunting list, but its pretty simple when you break it down. Let's do each one at at time with some of the current
            code from HomeMarks. The HomeMarks app is my first check on the list. When I did this app just about EVERYTHING was done via an AJAX call
            to update the page. Now on to the others.
          </p>
          <h2>
            Head And Status Codes
          </h2>
          <p>
            The <a href="http://api.rubyonrails.com/classes/ActionController/Base.html#M000454">ActionController::Base#head</a> method and <a href=
            "http://dev.rubyonrails.org/browser/trunk/actionpack/lib/action_controller/status_codes.rb">HTTP status codes</a> are the second item on
            the list. The head method is very useful when you just want to respond with HTTP headers and no body content. This is typical behavior
            when an app responds to external web services requests. This is important to note, I chose to rely on head responses as a way to meet my
            design decision of not using any RJS responses from the controller.
          </p>
          <p>
            The basic usage of the head method is simple, you just pass a symbol to the head method that is the lowercase underscore equivalent to an
            HTTP status code. For instance, if you wanted to respond with success, choose a status code from the 200 range, the easiest being 'OK',
            which would look like <code>head(:ok)</code>. If you wanted to respond to bad authentication, you might use the 401 code like so,
            <code>head(:unauthorized)</code>. Here is an example from HomeMarks restful user signup action.
          </p>
          <div class="highlight">
            <pre>
<code class="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class=
"no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class=
"n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="n">head</span> <span class="ss">:ok</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code>
</pre>
          </div>
          <p>
            There is actually a number of things going on in those 2 lines of code above. If the user is created, the AJAX request will get a simple
            'OK' message via the head method. Obviously the client will need to know what to do on its own. But if errors happen what to do? This
            brings us to...
          </p>
          <h2>
            Invalid Object Handling
          </h2>
          <p>
            When Rails 2 came out, it gave us a very useful tool for our controllers, the <a href=
            "http://api.rubyonrails.com/classes/ActionController/Rescue/ClassMethods.html">ActionController#rescue_from</a> method. It allows you to
            delegate exception handling to a method either per controller or site wide for a specific exception class. So enter the <a href=
            "http://github.com/metaskills/homemarks/tree/master/lib/render_invalid_record.rb">RenderInvalidRecord</a> module, show below.
          </p>
          <div class="highlight">
            <pre>
<code class="ruby"><span class="k">module</span> <span class="nn">RenderInvalidRecord</span>
  
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class=
"n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="o">.</span><span class="n">rescue_from</span><span class="p">(</span><span class=
"no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span><span class="p">,</span> <span class=
"ss">:with</span> <span class="o">=&gt;</span> <span class="ss">:render_invalid_record</span><span class="p">)</span>
  <span class="k">end</span>
  
  <span class="kp">protected</span>
  
  <span class="k">def</span> <span class="nf">render_invalid_record</span><span class="p">(</span><span class="n">exception</span><span class=
"p">)</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">record</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class=
"n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">record</span><span class=
"o">.</span><span class="n">new_record?</span> <span class="p">?</span> <span class="s1">&#39;new&#39;</span> <span class="p">:</span> <span class=
"s1">&#39;edit&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>   <span class="p">{</span> <span class=
"n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="n">record</span><span class="o">.</span><span class=
"n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="p">,</span> <span class="ss">:status</span> <span class=
"o">=&gt;</span> <span class="ss">:unprocessable_entity</span><span class="p">,</span> <span class="ss">:content_type</span> <span class=
"o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">xml</span>  <span class="p">{</span> <span class=
"n">render</span> <span class="ss">:xml</span> <span class="o">=&gt;</span> <span class="n">record</span><span class="o">.</span><span class=
"n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="p">,</span>  <span class="ss">:status</span> <span class=
"o">=&gt;</span> <span class="ss">:unprocessable_entity</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class=
"n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="n">record</span><span class="o">.</span><span class=
"n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="p">,</span> <span class="ss">:status</span> <span class=
"o">=&gt;</span> <span class="ss">:unprocessable_entity</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  
<span class="k">end</span>
</code>
</pre>
          </div>
          <p>
            Once included in your application.rb file, every ActiveRecord::RecordInvalid exception will be handled by the render_invalid_record
            method. I use this pattern often and it is the primary reason I always use the <strong>bang methods</strong> that end with an exclamation
            point, such as <code>create!</code> or <code>save!</code>. This module above was inspired by <a href="http://github.com/josh/">Joshua
            Peek's</a> own module of the same name but has been edited here to fit my needs. Both the "xml" and "html" response formats are not used
            by HomeMarks but are included here to show how this module can work for any request type.
          </p>
          <p>
            Now, how this fits into the AJAX Head pattern. The design decision of not having RJS responses means one of two things needs to come from
            the response. First, if the response is a success, meaning in the 200 range, then it is assumed that the client only needs to know that
            all is 'OK'. Second, if the request has errors, then the response needs to communicate them. I choose JSON for the format of these errors
            since all AJAX request objects from Prototype automatically include a <code>application/json</code> accept header. So that is why I
            changed both the "js" and the "json" response type in the RenderInvalidRecord module to both serialize the objects full error messages
            into a JSON array with an HTTP status code of 422 "Unprocessable Entity" which seemed to make the most sense to me. This pretty much
            wraps up the server side part of the pattern. Now onto the client side. Everything from here on is personal taste on how your client will
            react to an "good" or "bad" response object.
          </p>
          <h2>
            Client-Side AJAX Handlers
          </h2>
          <p>
            I can not stress enough how much you have to bake your own functions to handle the client side reaction to both good and bad AJAX
            responses. The client's ability to know what to do with errors will be tightly coupled to AJAX handlers and the design choices of your
            site. In the examples below I have broken up methods in the same JavaScript classes to show you the parts for a specific behavior in a
            more concise manner. Also please note that I am using Prototype module and class organization heavily in HomeMarks. This allows me to
            build a Base JavaScript module and classes that mimic Rails models which inherit/mixin Base methods. I also use the Scriptaculous Builder
            class for creating DOM fragments too. Now back to business.
          </p>
          <div class="center">
            <video title="HomeMarks v2 Signup" src="/assets/signup.mp4" width="617" height="473" controls preload></video>
          </div>
          <p>
            The first part of the AJAX head pattern was to use unobtrusive JavaScript. Because of this design choice, there are no
            <code>remote_form_for</code> methods in the HomeMarks view code. All forms are simple <code>form_for</code> methods. Below is a sample of
            the HomeMarksSite JavaScript class that creates AJAX handlers for all site forms. The below example is slimmed down to only show the
            initialization of this behavior for the signup form. But no matter which form is given this behavior the process is the same.
          </p>
          <ul class="ml20 mr20 mb20">
            <li>The form's submit event is handled by <code>startAjaxForm()</code>. It does the following:
            </li>
            <li style="list-style: none; display: inline">
              <ul>
                <li>Stops the normal submit behavior.
                </li>
                <li>Adds a loading spinner in the #form_loading span.
                </li>
                <li>Creates a new AJAX.Request using the forms own action. It also binds a function to delegate the logic of completing the form when
                the request is finished. More on that later in #2 below.
                </li>
                <li>Finally it disables the form.
                </li>
              </ul>
            </li>
            <li>Once a response comes back from the server, the <code>delegateCompleteAjaxForm()</code> function will be called with both the form
            object and the AJAX request object. The logic of this function includes:
            </li>
            <li style="list-style: none; display: inline">
              <ul>
                <li>Figuring out the "mood" of the request using getRequestMood() function which is part of my base module.
                </li>
                <li>Sends the form and mood to the <code>completeAjaxForm()</code> function. This function will replace the loading spinner with an
                image that reflects a good or bad response.
                </li>
                <li>If the mood is good, meaning the response status code was within a 200 range, then the function will delegate to a function
                specific for that forms success using a simple case statement.
                </li>
                <li>If this mood is bad, meaning the response status code not within a 200 range, the form will be enabled and the response JSON
                errors will be displayed. Currently I am using a modal class for this. Again more on that later. You may also note that my base
                module has a function called <code>messagesToList()</code> that process the response into a DOM &lt;ul&gt; list.
                </li>
              </ul>
            </li>
          </ul>
          <div class="highlight">
            <pre>
<code class="javascript"><span class="kd">var</span> <span class="nx">HomeMarksBase</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">getRequestMood</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class=
"nx">status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class=
"nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">300</span><span class=
"p">)</span> <span class="o">?</span> <span class="s1">&#39;good&#39;</span> <span class="o">:</span> <span class=
"s1">&#39;bad&#39;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">messagesToList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">request</span><span class=
"p">.</span><span class="nx">responseJSON</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">messageList</span> <span class="o">=</span> <span class="nx">UL</span><span class="p">();</span>
    <span class="nx">messages</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class=
"kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span> 
      <span class="nx">messageList</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class=
"nx">LI</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">escapeHTML</span><span class=
"p">())</span> <span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">messageList</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">HomeMarksSite</span> <span class="o">=</span> <span class="nx">Class</span><span class=
"p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">HomeMarksBase</span><span class="p">,{</span> 
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signupForm</span> <span class="o">=</span> <span class=
"nx">$</span><span class="p">(</span><span class="s1">&#39;signup_form&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">initEvents</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">startAjaxForm</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nx">event</span><span class=
"p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nb">Object</span><span class=
"p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">imgSrc</span><span class="o">:</span><span class=
"s1">&#39;loading_invert.gif&#39;</span><span class="p">},</span> <span class="nx">arguments</span><span class="p">[</span><span class=
"mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="p">{});</span>
    <span class="kd">var</span> <span class="nx">loadArea</span> <span class="o">=</span> <span class="nx">form</span><span class=
"p">.</span><span class="nx">down</span><span class="p">(</span><span class="s1">&#39;#form_loading&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">imgTag</span> <span class="o">=</span> <span class="nx">IMG</span><span class=
"p">({</span><span class="nx">src</span><span class="o">:</span><span class="p">(</span><span class="s1">&#39;/images/&#39;</span><span class=
"o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">imgSrc</span><span class="p">)});</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">loadArea</span><span class="p">).</span><span class=
"nx">update</span><span class="p">(</span><span class="nx">imgTag</span><span class="p">);</span>
    <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class=
"p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">action</span><span class="p">,{</span>
      <span class="nx">onComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">request</span><span class="p">){</span> <span class="k">this</span><span class="p">.</span><span class=
"nx">delegateCompleteAjaxForm</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span><span class=
"nx">request</span><span class="p">)</span> <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class=
"k">this</span><span class="p">),</span>
      <span class="nx">parameters</span><span class="o">:</span> <span class="nx">form</span><span class="p">.</span><span class=
"nx">serialize</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="p">});</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">disable</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">delegateCompleteAjaxForm</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">form</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mood</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class=
"nx">getRequestMood</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">completeAjaxForm</span><span class="p">(</span><span class=
"nx">form</span><span class="p">,{</span><span class="nx">mood</span><span class="o">:</span><span class="nx">mood</span><span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mood</span> <span class="o">==</span> <span class=
"s1">&#39;good&#39;</span><span class="p">)</span> <span class="p">{</span> 
      <span class="k">switch</span> <span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">case</span> <span class="k">this</span><span class="p">.</span><span class="nx">supportForm</span> <span class=
"o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">completeSupportForm</span><span class="p">(</span><span class=
"nx">request</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span> 
      <span class="nx">form</span><span class="p">.</span><span class="nx">enable</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">request</span><span class="p">.</span><span class=
"nx">responseText</span><span class="p">.</span><span class="nx">blank</span><span class="p">())</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">flashHTML</span> <span class="o">=</span> <span class="nx">DIV</span><span class=
"p">([</span><span class="nx">H2</span><span class="p">(</span><span class="s1">&#39;Errors On Form!&#39;</span><span class="p">),</span><span class=
"k">this</span><span class="p">.</span><span class="nx">messagesToList</span><span class="p">(</span><span class="nx">request</span><span class=
"p">)]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">flashModal</span><span class="p">(</span><span class=
"s1">&#39;bad&#39;</span><span class="p">,</span><span class="nx">flashHTML</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">},</span>
  <span class="nx">completeAjaxForm</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nb">Object</span><span class=
"p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nx">mood</span><span class="o">:</span><span class=
"s1">&#39;good&#39;</span><span class="p">},</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class=
"p">]</span> <span class="o">||</span> <span class="p">{});</span>
    <span class="kd">var</span> <span class="nx">loadArea</span> <span class="o">=</span> <span class="nx">form</span><span class=
"p">.</span><span class="nx">down</span><span class="p">(</span><span class="s1">&#39;#form_loading&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">completeId</span> <span class="o">=</span> <span class=
"s1">&#39;complete_ajax_form_&#39;</span> <span class="o">+</span> <span class="nx">form</span><span class="p">.</span><span class=
"nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">imgSrc</span> <span class="o">=</span> <span class="s1">&#39;/images/&#39;</span><span class=
"o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">mood</span><span class="o">+</span><span class=
"s1">&#39;.png&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">moodHtml</span> <span class="o">=</span> <span class="nx">SPAN</span><span class=
"p">({</span><span class="nx">id</span><span class="o">:</span><span class="nx">completeId</span><span class="p">,</span><span class=
"nx">className</span><span class="o">:</span><span class="s1">&#39;m0 p0&#39;</span><span class="p">},</span> <span class="p">[</span><span class=
"nx">IMG</span><span class="p">({</span><span class="nx">src</span><span class="o">:</span><span class="nx">imgSrc</span><span class="p">})]);</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">loadArea</span><span class="p">).</span><span class=
"nx">update</span><span class="p">(</span><span class="nx">moodHtml</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class=
"p">{</span> <span class="nx">$</span><span class="p">(</span><span class="nx">completeId</span><span class="p">).</span><span class=
"nx">fade</span><span class="p">();</span> <span class="p">},</span><span class="mi">3000</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">completeSignupForm</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class=
"s2">&quot;Thank your for signing up for your own HomeMarks page. An email has been sent to &quot;</span> <span class="o">+</span>
      <span class=
"s2">&quot;your address along with a link to activate your account. If you have not done so already, please &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;take a moment to read the HomeMarks documentation.&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">flashHTML</span> <span class="o">=</span> <span class="nx">DIV</span><span class=
"p">([</span><span class="nx">H2</span><span class="p">(</span><span class="s1">&#39;Signup Complete:&#39;</span><span class=
"p">),</span><span class="nx">P</span><span class="p">(</span><span class="nx">message</span><span class="p">)]);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class=
"s1">&#39;good&#39;</span><span class="p">,</span><span class="nx">flashHTML</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">initEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class=
"nx">signupForm</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class=
"nx">signupForm</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class=
"s1">&#39;submit&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class=
"nx">startAjaxForm</span><span class="p">.</span><span class="nx">bindAsEventListener</span><span class="p">(</span><span class=
"k">this</span><span class="p">));</span> <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span>
</code>
</pre>
          </div>
          <h2>
            Client-Side Error Handling
          </h2>
          <p>
            Currently I have 3 client-side options that I can use to present errors back to the user from the JSON array in AJAX response. The first
            I started out with was using the <code>alert()</code> function. That got boring real quick, but I left my implementation below which is
            part of the base class, called <code>messagesToAlert()</code>.
          </p>
          <p>
            The second slightly more interesting way was to create a flash message that used the same XHTML/CSS already present in my layout file.
            This was real easy to implement. Basically using the ERB fragment below in my layout, I guaranteed that I had 3 unique DOM elements for
            each of my flash message styles, good/bad/indif. Now all I had to do was to create an accessor in my HomeMarksSite class. I choose
            <code>this.flashes</code>. I then created a <code>clearFlashes()</code> function and then a <code>flash()</code> function that would take
            the mood and the HTML to embed, viola â€“ I can now call <code>this.flash.('good',someHTML)</code> and I get the same type of flash one
            would have seen if I set it in the controller and rendered. Note, this is what I used on the the signup form success above.
          </p>
          <div class="highlight">
            <pre>
<code class="ruby"><span class="o">&lt;</span><span class="sx">% [:good,:bad,:indif].each </span><span class="k">do</span> <span class=
"o">|</span><span class="n">key</span><span class="o">|</span> <span class="sx">%&gt;</span>
<span class="sx">  &lt;div id=&quot;flash_&lt;%= key %&gt;</span><span class="s2">&quot; class=&quot;</span><span class=
"n">flash_message</span><span class="s2">&quot; style=&quot;</span><span class="nb">display</span><span class="p">:</span><span class=
"o">&lt;</span><span class="sx">%= flash[key].blank? ? &#39;none&#39; : &#39;block&#39; %&gt;;&quot;&gt;</span>
<span class="sx">         &lt;span&gt;&lt;%=</span> <span class="n">flash</span><span class="o">[</span><span class="n">key</span><span class=
"o">]</span> <span class="sx">%&gt;&lt;/span&gt;</span>
        <span class="o">&lt;</span><span class="sr">/div&gt;</span>
<span class="sr">&lt;% end %&gt;</span>
</code>
</pre>
          </div><br>
          <div class="highlight">
            <pre>
<code class="javascript"><span class="kd">var</span> <span class="nx">HomeMarksBase</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">messagesToAlert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">request</span><span class=
"p">.</span><span class="nx">responseJSON</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">alertText</span> <span class="o">=</span> <span class="nx">messages</span><span class=
"p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;.\n&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">alertText</span><span class="p">.</span><span class=
"nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="p">{</span> <span class=
"nx">alert</span><span class="p">(</span><span class="nx">alertText</span><span class="p">);</span> <span class="p">}</span> <span class=
"k">else</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">alertText</span><span class=
"o">+</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="p">};</span>
  <span class="p">},</span>
  <span class="nx">messagesToList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">request</span><span class=
"p">.</span><span class="nx">responseJSON</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">messageList</span> <span class="o">=</span> <span class="nx">UL</span><span class="p">();</span>
    <span class="nx">messages</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class=
"kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span> 
      <span class="nx">messageList</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class=
"nx">LI</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">escapeHTML</span><span class=
"p">())</span> <span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">messageList</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">HomeMarksSite</span> <span class="o">=</span> <span class="nx">Class</span><span class=
"p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">HomeMarksBase</span><span class="p">,{</span> 
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flashes</span> <span class="o">=</span> <span class=
"nx">$$</span><span class="p">(</span><span class="s1">&#39;div.flash_message&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">clearFlashes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flashes</span><span class="p">.</span><span class=
"nx">invoke</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flashes</span><span class="p">.</span><span class=
"nx">invoke</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span><span class=
"s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">flash</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">mood</span><span class="p">,</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clearFlashes</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">moodFlash</span> <span class="o">=</span> <span class="k">this</span><span class=
"p">.</span><span class="nx">flashes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class=
"kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span> <span class="k">if</span> <span class=
"p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class=
"s1">&#39;flash_&#39;</span><span class="o">+</span><span class="nx">mood</span><span class="p">)</span> <span class="p">{</span><span class=
"k">return</span> <span class="kc">true</span><span class="p">};</span> <span class="p">});</span>
    <span class="nx">moodFlash</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class=
"nx">html</span><span class="p">);</span>
    <span class="nx">moodFlash</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;site_wrapper&#39;</span><span class="p">).</span><span class=
"nx">scrollTo</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code>
</pre>
          </div>
          <div class="center">
            <video title="HomeMarks v2 Signup" src="/assets/login.mp4" width="617" height="473" controls preload></video>
          </div>
          <p>
            Lastly, and probably the coolest, is the HomeMarksModal JavaScript class I created. This is my new default way of errors to a user. It
            can be seen in all my video examples on this page. To the right is another example of the login form that uses the same handlers
            described above. The HomeMarksModal JavaScript class is a bit large to paste inline in this article, but if you want to see the latest
            version, you can always get it <a href="http://github.com/metaskills/homemarks/tree/master/public/javascripts/homemarks/modal.js">from
            the master branch of the homemarks_core project</a> on Github.com. When you bind an instance of this object to the window/document, it
            will automatically crate the modal HTML using Builder. If you want to use it, make sure to get the CSS and images the project too. Below
            is a function that I put in my site class that allows me to call <code>this.flashModal('good',someHTML))</code>.
          </p>
          <div class="highlight">
            <pre>
<code class="javascript"><span class="kd">var</span> <span class="nx">HomeMarksSite</span> <span class="o">=</span> <span class=
"nx">Class</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">HomeMarksBase</span><span class=
"p">,{</span> 
  <span class="nx">flashModal</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class=
"nx">mood</span><span class="p">,</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">moodColor</span> <span class="o">=</span> <span class="k">this</span><span class=
"p">.</span><span class="nx">flashMoodColors</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class=
"nx">mood</span><span class="p">);</span>
    <span class="nx">HmModal</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class=
"nx">html</span><span class="p">,{</span><span class="nx">color</span><span class="o">:</span><span class="nx">moodColor</span><span class=
"p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</code>
</pre>
          </div>
          <h2>
            Wrapping It Up
          </h2>
          <p>
            This article turned out a lot longer than I had wanted. The AJAX head pattern is pretty simple and it is really fun to see a two line
            user signup action yield such interactive results. Something also feels good about not putting view code in the controller, yes you can
            look at inline RJS as view code. Sure it requires that you do a lot more JS work, but there are benefits.
          </p>
          <p>
            Image you have team of programmers, one person can stay in model/controller land while the other stays on the view/javascript. The
            model/controller person would write their own tests (PLEASE TAKE A LOOK AT MINE), while the view/javascript person might even take the
            initiative to use selenium to test the JavaScript. At the time of this writing, I have not done any selenium tests since the plugin for
            rails is not compatible for 2.0. That last benefit I could think of for this design pattern is that you could easily update view code
            without restarting your rails app. Just update the JavaScripts and your good to go.
          </p>
          <p>
            In closing, please let me know what you think. Perhaps you have a better name for the design pattern? Perhaps someone else has a name for
            it already?
          </p>
          <h2>
            Resources
          </h2>
          <ul>
            <li>Original <a href=
            "http://github.com/metaskills/homemarks/tree/d33dab1405537db2d2dab86d79db415d9e7f56e5/app/helpers/application_helper.rb">application_helper.rb</a>
            from HomeMarks v1. An overboard example of shared view/controller tagsoup/rjs.
            </li>
            <li>The latest <a href="http://www.pragprog.com/titles/fr_arr/advanced-rails-recipes"><em>Advanced Rails Recipes</em></a> book. See the
            chapter on "Replace In-View Raw JavaScript". I discourage this technique used in mass.
            </li>
            <li>Rails API for the <a href="http://api.rubyonrails.com/classes/ActionController/Base.html#M000454">ActionController::Base#head</a>
            method.
            </li>
            <li>Rails API for the <a href="http://dev.rubyonrails.org/browser/trunk/actionpack/lib/action_controller/status_codes.rb">HTTP status
            codes</a>.
            </li>
            <li>Rails API for the <a href=
            "http://api.rubyonrails.com/classes/ActionController/Rescue/ClassMethods.html">ActionController#rescue_from</a> method.
            </li>
            <li>The latest <a href="http://github.com/metaskills/homemarks/tree/master/lib/render_invalid_record.rb">RenderInvalidRecord</a> module
            from the HomeMarks core.
            </li>
            <li>The latest <a href="http://github.com/metaskills/homemarks/tree/master/public/javascripts/homemarks/modal.js">HomeMarksModal</a>
            JavaScript class from the HomeMarks core.
            </li>
          </ul>
          <footer id="disqus_thread">
            <script type="text/javascript">
var disqus_shortname = 'metaskillsnet';
            var disqus_identifier = '/2008/05/24/the-ajax-head-br-design-pattern/';
            var disqus_title = 'The "AJAX Head" Design Pattern';
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
            </script>
          </footer>
        </article>
      </section>
      <nav>
        <div>
          <a href="http://www.youtube.com/watch?v=8pBTK-pdMP0">Society for coding things on top of other things!</a>
        </div>
        <h3>
          Categories
        </h3>
        <ul>
          <li>
            <a href="/categories/heuristics.html">Heuristics</a>
          </li>
          <li>
            <a href="/categories/workflow.html">Workflow</a>
          </li>
          <li>
            <a href="/categories/apple-os.html">Apple/OS</a>
          </li>
          <li>
            <a href="/categories/database.html">Database</a>
          </li>
          <li>
            <a href="/categories/lifestyle.html">Lifestyle</a>
          </li>
          <li>
            <a href="/categories/miscellaneous.html">Miscellaneous</a>
          </li>
          <li>
            <a href="/categories/ruby-rails.html">Ruby/Rails</a>
          </li>
          <li>
            <a href="/categories/javascript.html">JavaScript</a>
          </li>
          <li>
            <a href="/categories/tools.html">Tools</a>
          </li>
        </ul>
      </nav>
    </section>
    <footer id="foot">
      <section id="footer">
        <section id="recentposts">
          <h3>
            Recent Posts
          </h3>
          <article>
            <h4>
              The Browser Is Dead?
            </h4>
            <p>
              <a href="/2011/05/21/the-browser-is-dead">This twitter post by Dave Thomas sparked an interesting back and forth with DHH on how Rails
              3.1 could be more opinionated towards web development for the browser. A short...</a>
            </p>
          </article>
          <article>
            <h4>
              Use Compass Sass Framework Files With The Rails 3.1 Asset Pipeline
            </h4>
            <p>
              <a href="/2011/05/18/use-compass-sass-framework-files-with-the-rails-3.1-asset-pipeline">The Sprockets 2 gem along with the Tilt gem
              make it really easy to write JavaScript or CSS using any templating language you desire. The rails defaults are CoffeeScript and...</a>
            </p>
          </article>
          <article>
            <h4>
              Speaking At MADExpo
            </h4>
            <p>
              <a href="/2011/05/06/speaking_at_madexpo">Over the past few months I have been actively working with both Luis Lavena and Wayne E
              Seguin to incorporate both TinyTDS and the SQL Server Adapter into the latest...</a>
            </p>
          </article>
          <aside id="powered">
            <span>Powered by <a href="http://github.com/henrik/jekyll">Jekyll</a> and <a href="http://disqus.com">Disqus</a>. Check out <a href=
            "https://github.com/metaskills/metaskills.net">the code</a>.</span><br>
            <span>&copy; 2006-2011 Ken Collins. All rights reserved.</span>
          </aside>
          <aside id="html5_badge">
            <a href="http://www.w3.org/html/logo/"></a>
          </aside>
        </section>
        <section id="badges">
          <ul>
            <li>
              <a id="badge_js" href="https://developer.mozilla.org/en/JavaScript" title='JavaScript'>JavaScript</a>
            </li>
            <li>
              <a id="badge_ios" href="http://developer.apple.com/"></a>
            </li>
            <li>
              <a id="badge_railscore" href="http://contributors.rubyonrails.org/contributors/ken-collins/commits"></a>
            </li>
            <li>
              <a id="badge_pragalumni" href="http://alumni.pragmaticstudio.com/users/128"></a>
            </li>
            <li>
              <a id="badge_linkedin" href="http://www.linkedin.com/in/metaskills"></a>
            </li>
            <li>
              <a id="badge_slideshare" href="http://www.slideshare.net/metaskills"></a>
            </li>
            <li>
              <a id="badge_757rb" href="http://757rb.org/"></a>
            </li>
          </ul>
        </section>
        <section id="blogroll">
          <h3>
            Blogroll
          </h3>
          <ul>
            <li>
              <a href="http://ryan.mcgeary.org/">Ryan McGeary</a>
            </li>
            <li>
              <a href="http://www.linkedin.com/in/imbriaco">Mark Imbriaco</a>
            </li>
            <li>
              <a href="http://mwhuss.com/">Marshall Huss</a>
            </li>
            <li>
              <a href="http://fun3d.larc.nasa.gov/">Bil Kleb</a>
            </li>
            <li>
              <a href="http://www.buzzwordcompliant.net/">Mike Buckbee</a>
            </li>
            <li>
              <a href="http://www.candescence.org/">Geoff Parsons</a>
            </li>
            <li>
              <a href="http://www.wearetitans.net/">Brennan Dunn</a>
            </li>
            <li>
              <a href="http://evan.tiggerpalace.com/">Evan Light</a>
            </li>
            <li>
              <a href="http://techiferous.com/">Wyatt Greene</a>
            </li>
            <li>
              <a href="http://www.engineyard.com/blog/author/wayneseguin/">Wayne E. Sequin</a>
            </li>
          </ul>
        </section>
      </section>
    </footer>
  </body>
</html>
